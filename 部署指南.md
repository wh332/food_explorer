# 美食探索者 - 部署指南

## 快速部署步骤

### 1. 环境准备
```bash
# 检查Node.js版本
node --version  # 需要 18.0+

# 检查npm版本  
npm --version   # 需要 9.0+
```

### 2. 项目初始化
```bash
# 下载项目代码
git clone <项目地址>
cd food-explorer

# 安装依赖
npm install

# 开发模式运行
npm run dev
```

### 3. Supabase配置

#### 3.1 创建Supabase项目
1. 访问 [Supabase官网](https://supabase.com)
2. 创建新项目，项目名称: `food-explorer`
3. 等待项目初始化完成

#### 3.2 配置存储桶
在Supabase控制台执行：
```sql
-- 创建用户照片存储桶
INSERT INTO storage.buckets (id, name, public) 
VALUES ('user-photos', 'user-photos', true);

-- 创建菜系照片存储桶  
INSERT INTO storage.buckets (id, name, public)
VALUES ('cuisine-photos', 'cuisine-photos', true);
```

#### 3.3 配置数据库表
```sql
-- 创建用户照片表
CREATE TABLE user_photos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL,
  file_name TEXT NOT NULL, 
  file_url TEXT NOT NULL,
  file_size INTEGER NOT NULL,
  upload_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  is_avatar BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建菜系照片表
CREATE TABLE cuisine_photos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cuisine_id TEXT NOT NULL,
  file_name TEXT NOT NULL,
  file_url TEXT NOT NULL, 
  file_size INTEGER NOT NULL,
  upload_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 启用行级安全
ALTER TABLE user_photos ENABLE ROW LEVEL SECURITY;
ALTER TABLE cuisine_photos ENABLE ROW LEVEL SECURITY;

-- 配置访问策略
CREATE POLICY "允许匿名用户读取照片" ON user_photos
FOR SELECT USING (true);

CREATE POLICY "允许匿名用户插入照片" ON user_photos  
FOR INSERT WITH CHECK (true);

CREATE POLICY "允许匿名用户更新自己的照片" ON user_photos
FOR UPDATE USING (true);

CREATE POLICY "允许匿名用户删除自己的照片" ON user_photos
FOR DELETE USING (true);
```

#### 3.4 获取API密钥
在Supabase项目设置中获取：
- **项目URL**: `https://dpmpxpsbwssmoshpruup.supabase.co`
- **anon public密钥**: `eyJhbGci...`
- **service_role密钥**: `eyJhbGci...` (仅服务器端使用)

### 4. 环境变量配置

创建 `.env` 文件：
```env
# Supabase配置
VITE_SUPABASE_URL=https://dpmpxpsbwssmoshpruup.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwbXB4cHNid3NzbW9zaHBydXVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NTY2NjUsImV4cCI6MjA3NjEzMjY2NX0.LHByt25fw0XIi4rQkonSsP7Z_rMyG46VspZ0_zkpNV0

# 可选：生产环境配置
VITE_APP_VERSION=1.0.0
VITE_APP_NAME=美食探索者
```

### 5. 构建和部署

#### 5.1 开发环境
```bash
# 开发模式运行
npm run dev

# 访问地址
# 本地: http://localhost:3001/
# 网络: http://<你的IP>:3001/
```

#### 5.2 生产环境构建
```bash
# 构建生产版本
npm run build

# 预览构建结果
npm run preview

# 构建产物在 dist/ 目录
```

#### 5.3 服务器部署
将 `dist/` 目录内容上传到Web服务器：
- **Nginx配置示例**:
```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /var/www/food-explorer;
    index index.html;

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # SPA路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

### 6. 域名和SSL配置

#### 6.1 域名解析
- 将域名A记录指向服务器IP
- 等待DNS生效（通常几分钟到几小时）

#### 6.2 SSL证书配置
使用Let's Encrypt免费SSL证书：
```bash
# 安装certbot
sudo apt update
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

## 故障排除

### 常见问题

#### 1. Supabase连接失败
**症状**: 照片上传失败，控制台显示连接错误  
**解决方案**:
- 检查Supabase项目URL和密钥是否正确
- 确认存储桶已创建并配置权限
- 检查网络连接和防火墙设置

#### 2. 照片上传失败
**症状**: 上传进度卡住或报错  
**解决方案**:
- 检查文件大小是否超过5MB限制
- 确认存储桶存储空间充足
- 检查文件格式支持（JPG/PNG）

#### 3. 构建错误
**症状**: `npm run build` 失败  
**解决方案**:
- 清除node_modules重新安装: `rm -rf node_modules && npm install`
- 检查Node.js版本兼容性
- 查看具体错误信息进行针对性修复

### 性能优化建议

#### 1. 图片优化
```bash
# 安装图片优化工具
npm install -g sharp-cli

# 批量优化图片
sharp-cli input/*.jpg --output dist/images/ --quality 80
```

#### 2. 缓存策略
- 配置CDN加速静态资源
- 启用浏览器缓存
- 使用Service Worker缓存关键资源

#### 3. 监控和分析
- 集成Google Analytics跟踪用户行为
- 使用性能监控工具（如Lighthouse）
- 定期检查Core Web Vitals指标

## 维护和更新

### 日常维护
- 定期备份数据库
- 监控服务器资源使用情况
- 更新依赖包到安全版本

### 版本更新
```bash
# 检查可用更新
npm outdated

# 安全更新
npm audit fix

# 主要版本更新
npm update
```

### 数据备份
```bash
# Supabase数据库备份
# 在Supabase控制台设置自动备份
# 或使用pg_dump手动备份

# 文件备份
tar -czf backup-$(date +%Y%m%d).tar.gz dist/ uploads/
```

## 技术支持

如遇问题，请提供以下信息：
1. 错误日志截图
2. 浏览器控制台输出
3. 网络环境描述
4. 操作步骤复现

**技术支持邮箱**: support@example.com  
**文档更新**: 本项目文档会持续更新，请关注最新版本

---
*部署指南版本: v1.0.0*  
*最后更新: 2025年10月21日*