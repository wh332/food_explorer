# 数据库部署指南

## 概述

本文档指导如何将新的数据库结构部署到Supabase，包括用户信息表的创建和初始化。

## 数据库结构变更

### 新增表结构

1. **user_profiles 表** - 用户信息表
   - `id` (UUID, 主键)
   - `user_id` (TEXT, 唯一索引，关联Supabase Auth用户ID)
   - `username` (TEXT, 用户名，唯一索引)
   - `email` (TEXT, 邮箱)
   - `full_name` (TEXT, 可选，全名)
   - `bio` (TEXT, 可选，个人简介)
   - `avatar_url` (TEXT, 可选，头像URL)
   - `location` (TEXT, 可选，位置)
   - `website` (TEXT, 可选，个人网站)
   - `preferences` (JSONB, 可选，用户偏好设置)
   - `created_at` (TIMESTAMP, 创建时间)
   - `updated_at` (TIMESTAMP, 更新时间)

### 新增索引

- `idx_user_profiles_user_id` - 用户ID索引
- `idx_user_profiles_username` - 用户名索引
- `idx_user_profiles_email` - 邮箱索引

### 新增安全策略

- "用户只能访问自己的信息" - 行级安全策略，确保用户只能访问自己的用户信息

## 部署步骤

### 方法一：使用Supabase SQL编辑器

1. 登录到Supabase控制台
2. 进入你的项目
3. 点击左侧菜单的 "SQL Editor"
4. 复制 `supabase_init.sql` 文件中的内容
5. 在SQL编辑器中执行整个脚本
6. 确认所有表、索引和安全策略都成功创建

### 方法二：使用命令行工具

如果你有Supabase CLI工具，可以执行以下命令：

```bash
# 登录到Supabase
supabase login

# 链接到你的项目
supabase link --project-ref your-project-ref

# 执行SQL脚本
supabase db push
```

### 方法三：分步执行

如果遇到执行问题，可以分步执行SQL语句：

1. 先创建表结构
2. 然后启用行级安全策略
3. 接着创建安全策略
4. 最后创建索引

## 验证部署

### 检查表是否创建成功

```sql
-- 检查表是否存在
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name = 'user_profiles';
```

### 检查索引是否创建成功

```sql
-- 检查索引是否存在
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'user_profiles';
```

### 检查安全策略是否生效

```sql
-- 检查安全策略
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies 
WHERE tablename = 'user_profiles';
```

## 数据迁移（如果需要）

如果你的项目已经有用户数据，可能需要迁移现有用户信息到新的 `user_profiles` 表。

### 迁移现有用户数据

```sql
-- 从Supabase Auth迁移用户数据到user_profiles表
INSERT INTO user_profiles (user_id, email, username, created_at, updated_at)
SELECT 
    id as user_id,
    email,
    COALESCE(raw_user_meta_data->>'username', split_part(email, '@', 1)) as username,
    created_at,
    NOW() as updated_at
FROM auth.users
WHERE id NOT IN (SELECT user_id FROM user_profiles);
```

## 故障排除

### 常见问题

1. **表已存在错误**
   - 如果表已存在，可以删除重建或使用 `CREATE TABLE IF NOT EXISTS`

2. **权限错误**
   - 确保有足够的权限执行DDL语句
   - 检查数据库连接配置

3. **索引冲突**
   - 如果索引已存在，先删除再重建

4. **安全策略冲突**
   - 如果策略已存在，先删除再重建

### 回滚方案

如果部署出现问题，可以执行以下回滚脚本：

```sql
-- 删除索引
DROP INDEX IF EXISTS idx_user_profiles_user_id;
DROP INDEX IF EXISTS idx_user_profiles_username;
DROP INDEX IF EXISTS idx_user_profiles_email;

-- 删除安全策略
DROP POLICY IF EXISTS "用户只能访问自己的信息" ON user_profiles;

-- 禁用行级安全
ALTER TABLE user_profiles DISABLE ROW LEVEL SECURITY;

-- 删除表
DROP TABLE IF EXISTS user_profiles;
```

## 后续维护

### 定期备份

建议定期备份数据库，特别是用户数据：

```sql
-- 备份用户数据
SELECT * FROM user_profiles;
```

### 监控和优化

定期监控数据库性能，特别是用户相关的查询：

```sql
-- 查看查询性能
EXPLAIN ANALYZE SELECT * FROM user_profiles WHERE user_id = 'user-id';
```

## 联系支持

如果遇到问题，请联系：
- 项目维护者
- Supabase官方文档
- 社区支持论坛

---

**注意**: 在生产环境部署前，请务必在测试环境验证所有变更。